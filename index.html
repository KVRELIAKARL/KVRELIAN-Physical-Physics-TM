<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Physical Physics - By KVRELIA</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #f0f0f5;
            touch-action: none;
        }

        /* Startup Screen */
        .startup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            transition: opacity 0.8s ease;
        }

        .startup-logo {
            width: 300px;
            height: 300px;
            border-radius: 26px;
            overflow: hidden;
            animation: float 3s ease-in-out infinite;
        }

        .startup-logo video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-20px); }
        }

        /* Progress Bar */
        .startup-progress-container {
            width: 280px;
            margin-top: 32px;
        }

        .startup-progress-text {
            color: white;
            font-size: 14px;
            margin-bottom: 8px;
            text-align: center;
            font-weight: 500;
        }

        .startup-progress {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
        }

        .startup-progress-bar {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #007AFF, #00A8FF);
            border-radius: 3px;
            transition: width 0.4s cubic-bezier(0.65, 0, 0.35, 1);
            position: relative;
        }

        .startup-progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, 
                            rgba(255,255,255,0.3) 0%, 
                            rgba(255,255,255,0.5) 50%, 
                            rgba(255,255,255,0.3) 100%);
            background-size: 200% 100%;
            animation: shimmer 2s infinite;
            border-radius: 3px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* Setup Screen */
        .setup-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: #f7f7fc;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 999;
            opacity: 0;
            transition: opacity 0.8s ease;
            padding: 20px;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        .setup-container {
            width: 100%;
            max-width: 500px;
            max-height: 80vh;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .setup-header {
            padding: 20px;
            background: linear-gradient(to bottom, #f7f7fc, #ffffff);
            border-bottom: 1px solid #e5e5ea;
            text-align: center;
            flex-shrink: 0;
        }

        .setup-title {
            font-size: 22px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 8px;
        }

        .setup-subtitle {
            font-size: 14px;
            color: #636366;
        }

        .setup-content {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            -webkit-overflow-scrolling: touch;
        }

        .setup-section {
            margin-bottom: 24px;
        }

        .setup-section-title {
            font-size: 16px;
            font-weight: 500;
            color: #1c1c1e;
            margin-bottom: 12px;
        }

        .language-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 12px;
            padding: 8px;
        }

        .language-option {
            padding: 12px;
            border: 1px solid #e5e5ea;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            user-select: none;
        }

        .language-option:hover {
            transform: scale(1.05);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .language-option.selected {
            border-color: #007AFF;
            background-color: #e6f2ff;
        }

        .language-flag {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            margin-bottom: 8px;
            object-fit: cover;
        }

        .language-name {
            font-size: 14px;
            font-weight: 500;
            color: #1c1c1e;
        }

        .tutorial-steps {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .tutorial-step {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .tutorial-icon {
            width: 24px;
            height: 24px;
            background: #007AFF;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 14px;
            flex-shrink: 0;
        }

        .tutorial-text {
            font-size: 14px;
            color: #636366;
            line-height: 1.5;
        }

        .setup-footer {
            padding: 16px 20px;
            background: #f7f7fc;
            border-top: 1px solid #e5e5ea;
            display: flex;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .setup-button {
            padding: 8px 20px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .setup-button.primary {
            background: #007AFF;
            color: white;
            border: none;
        }

        .setup-button.primary:hover {
            background: #0066CC;
        }

        .setup-button.secondary {
            background: transparent;
            border: 1px solid #e5e5ea;
            color: #636366;
        }

        .setup-button.secondary:hover {
            background: #f5f5f7;
        }

        /* Logo Replay Screen */
        .logo-replay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: white;
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 998;
            opacity: 0;
            transition: opacity 0.8s ease;
        }

        .logo-replay .startup-logo {
            animation: none;
            width: 400px;
            height: 400px;
        }

        /* Menu Bar */
        .menu-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 44px;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(30px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 500;
            -webkit-backdrop-filter: blur(30px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .menu-title {
            font-size: 16px;
            font-weight: 500;
            color: #1a1a1a;
        }

        /* Dock */
        .dock {
            position: fixed;
            background: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(40px);
            border-radius: 16px;
            padding: 12px;
            display: none;
            gap: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            cursor: grab;
            user-select: none;
            opacity: 0;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            transition: opacity 0.5s ease-out, transform 0.5s ease-out;
            -webkit-backdrop-filter: blur(40px);
            touch-action: none;
            width: auto;
            max-width: 90%;
            margin: 0 auto;
            white-space: nowrap;
            overflow-x: auto;
        }

        .dock.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
        }

        .dock-item {
            width: 56px;
            height: 56px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: rgba(255, 255, 255, 0.7);
            transition: all 0.2s ease;
            font-size: 24px;
            user-select: none;
            flex-shrink: 0;
        }

        .dock-item:hover {
            transform: scale(1.1);
            background: rgba(255, 255, 255, 0.9);
        }

        .dock-item.active {
            background: rgba(0, 122, 255, 0.2);
        }

        /* Canvas */
        #canvas {
            position: fixed;
            top: 44px;
            left: 0;
            width: 100%;
            height: calc(100% - 44px);
            z-index: 0;
            touch-action: none;
        }

        /* macOS Style Tooltip */
        .object-tooltip {
            position: absolute;
            background-color: rgba(0, 0, 0, 0.8);
            color: white;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            pointer-events: none;
            z-index: 100;
            transform: translateY(10px);
            opacity: 0;
            transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: nowrap;
        }

        .object-tooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }

        .object-tooltip::after {
            content: '';
            position: absolute;
            top: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-bottom: 5px solid rgba(0, 0, 0, 0.8);
        }

        /* Edit Controls */
        .edit-controls {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 12px;
            display: none;
            gap: 10px;
            z-index: 1001;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            -webkit-backdrop-filter: blur(20px);
            touch-action: none;
        }

        .edit-btn {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 122, 255, 0.1);
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 18px;
            user-select: none;
        }

        .edit-btn:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        .edit-btn.active {
            background: rgba(0, 122, 255, 0.3);
        }

        .size-slider {
            width: 120px;
            display: flex;
            align-items: center;
        }

        .size-slider input {
            width: 100%;
        }

        /* Roulette System - Enhanced */
        .roulette-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .roulette-wheel {
            width: 320px;
            height: 320px;
            border-radius: 50%;
            background: #1c1c1e;
            position: relative;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            border: 8px solid #2c2c2e;
        }

        .roulette-center {
            width: 70px;
            height: 70px;
            background: white;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.3);
            transition: transform 0.2s;
            font-size: 18px;
            color: #1c1c1e;
        }

        .roulette-center:hover {
            transform: scale(1.05);
        }

        .roulette-center:active {
            transform: scale(0.95);
        }

        .roulette-section {
            position: absolute;
            width: 50%;
            height: 50%;
            transform-origin: bottom right;
            left: 0;
            top: 0;
            clip-path: polygon(0 0, 100% 0, 100% 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            padding-bottom: 30px;
            box-sizing: border-box;
            color: white;
            font-weight: bold;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.8);
            font-size: 14px;
            transition: filter 0.3s;
        }

        .roulette-section.highlight {
            filter: brightness(1.3);
        }

        .roulette-pointer {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 20px solid transparent;
            border-right: 20px solid transparent;
            border-top: 40px solid #FF3B30;
            z-index: 5;
            filter: drop-shadow(0 0 5px rgba(255, 59, 48, 0.7));
        }

        .roulette-result {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 80%;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .roulette-result h3 {
            margin-bottom: 10px;
            color: #1c1c1e;
            font-size: 20px;
        }

        .roulette-result p {
            color: #636366;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .roulette-result button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }

        .roulette-result button:hover {
            background: #0066CC;
        }

        /* Loot Box System */
        .lootbox-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .lootbox {
            width: 250px;
            height: 200px;
            background: linear-gradient(135deg, #FFD700, #FF9500);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            cursor: pointer;
            position: relative;
            overflow: hidden;
            transition: transform 0.3s;
        }

        .lootbox:hover {
            transform: scale(1.05);
        }

        .lootbox:active {
            transform: scale(0.95);
        }

        .lootbox::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(
                to bottom right,
                rgba(255, 255, 255, 0) 0%,
                rgba(255, 255, 255, 0.8) 50%,
                rgba(255, 255, 255, 0) 100%
            );
            transform: rotate(30deg);
            animation: shine 3s infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(30deg); }
            100% { transform: translateX(100%) rotate(30deg); }
        }

        .lootbox-content {
            font-size: 60px;
            font-weight: bold;
            color: white;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
            transition: transform 0.3s;
        }

        .lootbox.shaking .lootbox-content {
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-10px); }
            40%, 80% { transform: translateX(10px); }
        }

        .lootbox-result {
            margin-top: 30px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            max-width: 80%;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.5s;
        }

        .lootbox-result h3 {
            margin-bottom: 10px;
            color: #1c1c1e;
            font-size: 20px;
        }

        .lootbox-result p {
            color: #636366;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .lootbox-result button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 16px;
        }

        .lootbox-result button:hover {
            background: #0066CC;
        }

        /* Shop System */
        .shop-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .shop-window {
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            overflow-y: auto;
        }

        .shop-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .shop-header h2 {
            color: #1c1c1e;
            margin-bottom: 5px;
        }

        .shop-header p {
            color: #636366;
        }

        .shop-items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
        }

        .shop-item {
            background: #f5f5f7;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .shop-item:hover {
            transform: scale(1.05);
        }

        .shop-item-icon {
            font-size: 30px;
            margin-bottom: 10px;
        }

        .shop-item-name {
            font-weight: 500;
            margin-bottom: 5px;
            color: #1c1c1e;
        }

        .shop-item-price {
            color: #007AFF;
            font-weight: 600;
        }

        .shop-balance {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e5e5ea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-balance-amount {
            font-weight: 600;
            color: #007AFF;
        }

        .shop-close {
            margin-top: 20px;
            text-align: center;
        }

        .shop-close button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
        }

        .shop-close button:hover {
            background: #0066CC;
        }

        /* Menu Button */
        .menu-button {
            position: fixed;
            top: 60px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(20px);
            border-radius: 8px;
            display: none;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            -webkit-backdrop-filter: blur(20px);
            user-select: none;
        }

        .menu-button:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: scale(1.05);
        }

        /* Pause overlay */
        .pause-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1001;
            color: white;
            font-size: 24px;
        }

        .pause-overlay h2 {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .pause-btn {
            padding: 12px 24px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
            margin-top: 20px;
        }

        .pause-btn:hover {
            background: #0066CC;
        }

        /* Notification System */
        .notification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 6px;
            background: #007AFF;
            color: white;
            z-index: 2000;
            transition: opacity 0.3s;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
        }

        .notification.error {
            background: #FF3B30;
        }

        .notification.fade-out {
            opacity: 0;
        }

        /* Save/Load Controls */
        .save-load-controls {
            position: fixed;
            top: 60px;
            right: 20px;
            display: none;
            gap: 10px;
            z-index: 1000;
        }

        .save-btn, .load-btn {
            padding: 8px 16px;
            border-radius: 6px;
            background: rgba(0, 122, 255, 0.1);
            border: none;
            color: #007AFF;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .save-btn:hover, .load-btn:hover {
            background: rgba(0, 122, 255, 0.2);
        }

        /* Particle Effects */
        .particle {
            position: absolute;
            pointer-events: none;
            border-radius: 50%;
            opacity: 0.8;
            transform: translate(-50%, -50%);
        }

        /* Skin Glow Effects */
        .gold-glow {
            box-shadow: 0 0 15px rgba(255, 215, 0, 0.7);
            background: linear-gradient(135deg, #FFD700, #FFA500);
        }

        .silver-glow {
            box-shadow: 0 0 15px rgba(192, 192, 192, 0.7);
            background: linear-gradient(135deg, #C0C0C0, #E0E0E0);
        }

        .wooden-texture {
            background: linear-gradient(135deg, #8B4513, #A0522D);
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg"><path d="M0,0 L100,0 L100,100 L0,100 Z" fill="%238B4513" /><path d="M0,20 L100,20 M0,40 L100,40 M0,60 L100,60 M0,80 L100,80" stroke="%23A0522D" stroke-width="2" /></svg>');
            background-size: 50px 50px;
        }

        .crystal-glow {
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.8);
            background: linear-gradient(135deg, #00FFFF, #00BFFF);
            opacity: 0.9;
        }

        .neon-glow {
            box-shadow: 0 0 20px rgba(255, 0, 255, 0.8);
            background: linear-gradient(135deg, #FF00FF, #9400D3);
            animation: neonPulse 2s infinite alternate;
        }

        @keyframes neonPulse {
            from { box-shadow: 0 0 10px rgba(255, 0, 255, 0.6); }
            to { box-shadow: 0 0 30px rgba(255, 0, 255, 1); }
        }

        /* Mobile-specific styles */
        @media (max-width: 768px) {
            .dock {
                width: 90%;
                max-width: none;
                padding: 8px;
                gap: 8px;
                bottom: 10px;
            }
            
            .dock-item {
                width: 48px;
                height: 48px;
                font-size: 20px;
            }
            
            .menu-button {
                top: 10px;
                left: 10px;
                width: 36px;
                height: 36px;
            }
            
            .edit-controls {
                bottom: 80px;
                width: 90%;
                padding: 8px;
            }
            
            .save-load-controls {
                top: 10px;
                right: 10px;
            }
            
            .startup-logo {
                width: 200px;
                height: 200px;
            }
            
            .logo-replay .startup-logo {
                width: 300px;
                height: 300px;
            }

            .roulette-wheel {
                width: 280px;
                height: 280px;
            }

            .lootbox {
                width: 200px;
                height: 160px;
            }
        }

        /* Landscape mode adjustments */
        @media (orientation: landscape) {
            .dock {
                bottom: 10px;
                padding: 8px;
                gap: 8px;
            }
            
            .dock-item {
                width: 44px;
                height: 44px;
                font-size: 20px;
            }
            
            .menu-button {
                top: 10px;
                left: 10px;
            }
            
            .edit-controls {
                bottom: 70px;
            }
            
            .save-load-controls {
                top: 10px;
                right: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="startup-screen" id="startupScreen">
        <div class="startup-logo">
            <video autoplay muted loop playsinline id="startupVideo">
                <source src="https://i.imgur.com/8933jDg.mp4" type="video/mp4">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzAwIiBoZWlnaHQ9IjMwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDA3QUZGIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPlBoeXNpY2FsIFBoeXNpY3M8L3RleHQ+PC9zdmc+" alt="Physical Physics Logo">
                Your browser does not support the video tag.
            </video>
        </div>
        <div class="startup-progress-container">
            <div class="startup-progress-text" id="progressText">Loading Physical Physics</div>
            <div class="startup-progress">
                <div class="startup-progress-bar" id="startupProgress"></div>
            </div>
        </div>
    </div>

    <div class="setup-screen" id="setupScreen">
        <div class="setup-container">
            <div class="setup-header">
                <div class="setup-title" id="setupTitle">Welcome to Physical Physics</div>
                <div class="setup-subtitle" id="setupSubtitle">Let's get started with a few quick settings</div>
            </div>
            <div class="setup-content">
                <div class="setup-section">
                    <div class="setup-section-title" id="languageTitle">Select Language</div>
                    <div class="language-options">
                        <div class="language-option selected" data-lang="en">
                            <img src="https://flagcdn.com/w20/gb.png" class="language-flag">
                            <div class="language-name">English</div>
                        </div>
                        <div class="language-option" data-lang="es">
                            <img src="https://flagcdn.com/w20/es.png" class="language-flag">
                            <div class="language-name">Español</div>
                        </div>
                        <div class="language-option" data-lang="fr">
                            <img src="https://flagcdn.com/w20/fr.png" class="language-flag">
                            <div class="language-name">Français</div>
                        </div>
                        <div class="language-option" data-lang="de">
                            <img src="https://flagcdn.com/w20/de.png" class="language-flag">
                            <div class="language-name">Deutsch</div>
                        </div>
                        <div class="language-option" data-lang="ja">
                            <img src="https://flagcdn.com/w20/jp.png" class="language-flag">
                            <div class="language-name">日本語</div>
                        </div>
                        <div class="language-option" data-lang="ko">
                            <img src="https://flagcdn.com/w20/kr.png" class="language-flag">
                            <div class="language-name">한국어</div>
                        </div>
                        <div class="language-option" data-lang="tl">
                            <img src="https://flagcdn.com/w20/ph.png" class="language-flag">
                            <div class="language-name">Tagalog</div>
                        </div>
                        <div class="language-option" data-lang="sv">
                            <img src="https://flagcdn.com/w20/se.png" class="language-flag">
                            <div class="language-name">Svenska</div>
                        </div>
                    </div>
                </div>
                <div class="setup-section">
                    <div class="setup-section-title" id="tutorialTitle">Quick Tutorial</div>
                    <div class="tutorial-steps">
                        <div class="tutorial-step">
                            <div class="tutorial-icon">1</div>
                            <div class="tutorial-text" id="tutorialStep1">Tap on the dock icons to select different shapes to create</div>
                        </div>
                        <div class="tutorial-step">
                            <div class="tutorial-icon">2</div>
                            <div class="tutorial-text" id="tutorialStep2">Tap anywhere on the canvas to place your selected shape</div>
                        </div>
                        <div class="tutorial-step">
                            <div class="tutorial-icon">3</div>
                            <div class="tutorial-text" id="tutorialStep3">Long-press on objects to enter edit mode</div>
                        </div>
                        <div class="tutorial-step">
                            <div class="tutorial-icon">4</div>
                            <div class="tutorial-text" id="tutorialStep4">Select the trash icon to delete objects by tapping on them</div>
                        </div>
                        <div class="tutorial-step">
                            <div class="tutorial-icon">5</div>
                            <div class="tutorial-text" id="tutorialStep5">Use the menu button to access the roulette and shop</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="setup-footer">
                <button class="setup-button secondary" id="skipButton">Skip</button>
                <button class="setup-button primary" id="continueButton">Continue</button>
            </div>
        </div>
    </div>

    <div class="logo-replay" id="logoReplay">
        <div class="startup-logo">
            <video autoplay muted playsinline id="replayVideo">
                <source src="https://i.imgur.com/zSrGcf7.mp4" type="video/mp4">
                <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNDAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjMDA3QUZGIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIzNiIgZmlsbD0id2hpdGUiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGRvbWluYW50LWJhc2VsaW5lPSJtaWRkbGUiPlBoeXNpY2FsIFBoeXNpY3M8L3RleHQ+PC9zdmc+" alt="Physical Physics Logo">
                Your browser does not support the video tag.
            </video>
        </div>
    </div>

    <div class="menu-bar">
        <div class="menu-title" id="menuTitle">Physical Physics - By KVRELIA</div>
    </div>

    <div class="save-load-controls" id="saveLoadControls">
        <button class="save-btn" id="saveBtn">Save</button>
        <button class="load-btn" id="loadBtn">Load</button>
    </div>

    <div class="menu-button" id="menuButton">≡</div>
    <div class="menu-options" id="menuOptions" style="display: none; position: fixed; top: 110px; left: 20px; background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(20px); border-radius: 12px; padding: 12px; z-index: 1000; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1); display: none; flex-direction: column; gap: 8px; width: 200px; max-height: 70vh; overflow-y: auto;">
        <div class="menu-option" id="rouletteBtn">🎰 Roulette</div>
        <div class="menu-option" id="lootboxBtn">🎁 Loot Box</div>
        <div class="menu-option" id="shopBtn">🛒 Shop</div>
    </div>

    <div class="dock" id="dock">
        <div class="dock-item active" data-mode="box">🟦</div>
        <div class="dock-item" data-mode="circle">🔴</div>
        <div class="dock-item" data-mode="triangle">🔺</div>
        <div class="dock-item" data-mode="hexagon">⬡</div>
        <div class="dock-item" data-mode="static">🟩</div>
        <div class="dock-item" data-mode="delete">🗑️</div>
        <div class="dock-item" data-mode="pause">⏸️</div>
    </div>

    <canvas id="canvas"></canvas>
    <div id="tooltip" class="object-tooltip"></div>

    <div class="edit-controls" id="editControls">
        <button class="edit-btn" id="moveBtn">✋</button>
        <button class="edit-btn" id="resizeBtn">↔️</button>
        <div class="size-slider">
            <input type="range" id="sizeSlider" min="10" max="100" value="40">
        </div>
        <button class="edit-btn" id="confirmEditBtn">✓</button>
        <button class="edit-btn" id="cancelEditBtn">✕</button>
    </div>

    <!-- Roulette System -->
    <div class="roulette-container" id="rouletteContainer">
        <div class="roulette-wheel" id="rouletteWheel">
            <div class="roulette-pointer"></div>
            <div class="roulette-center" id="spinRoulette">SPIN</div>
        </div>
        <div class="roulette-result" id="rouletteResult">
            <h3 id="rouletteResultTitle">You won!</h3>
            <p id="rouletteResultText">100 points</p>
            <button id="rouletteCloseBtn">Close</button>
        </div>
    </div>

    <!-- Loot Box System -->
    <div class="lootbox-container" id="lootboxContainer">
        <div class="lootbox" id="openLootbox">
            <div class="lootbox-content">🎁</div>
        </div>
        <div class="lootbox-result" id="lootboxResult">
            <h3 id="lootboxResultTitle">You got!</h3>
            <p id="lootboxResultText">Gold Skin</p>
            <button id="lootboxCloseBtn">Close</button>
        </div>
    </div>

    <!-- Shop System -->
    <div class="shop-container" id="shopContainer">
        <div class="shop-window">
            <div class="shop-header">
                <h2>Shape Shop</h2>
                <p>Spend your yuan to unlock new shapes</p>
            </div>
            <div class="shop-items" id="shopItems">
                <!-- Items will be added dynamically -->
            </div>
            <div class="shop-balance">
                <div>Your Balance:</div>
                <div class="shop-balance-amount" id="shopBalance">0 yuan</div>
            </div>
            <div class="shop-close">
                <button id="shopCloseBtn">Close</button>
            </div>
        </div>
    </div>

    <!-- Pause Overlay -->
    <div class="pause-overlay" id="pauseOverlay">
        <h2>Paused</h2>
        <p>Edit your objects while paused</p>
        <button class="pause-btn" id="resumeBtn">Resume</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.18.0/matter.min.js"></script>
    <script>
        // Modules aliases
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Body = Matter.Body,
              Composite = Matter.Composite,
              Query = Matter.Query,
              Constraint = Matter.Constraint;

        let engine, render, runner;
        let currentMode = 'box';
        const bodies = [];
        let isProcessingClick = false;
        let selectedLanguage = 'en';

        // Edit mode variables
        let editMode = false;
        let moveMode = false;
        let resizeMode = false;
        let selectedBody = null;
        let originalBodyState = null;

        // Pause state
        let isPaused = false;
        let prePauseRunner = null;

        // Currency and skins system
        let points = 0;
        let yuan = 0;
        const unlockedShapes = ['box', 'circle', 'triangle', 'hexagon', 'static'];
        const skins = {
            box: ['default', 'gold', 'wooden'],
            circle: ['default', 'gold', 'silver'],
            triangle: ['default', 'gold', 'crystal'],
            hexagon: ['default', 'gold', 'neon']
        };
        const currentSkins = {
            box: 'default',
            circle: 'default',
            triangle: 'default',
            hexagon: 'default'
        };

        // Mobile detection
        function isMobile() {
            return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        }

        // Audio Manager
        const audio = {
            click: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-arcade-game-jump-coin-216.mp3'),
            thud: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-boxing-punch-2058.mp3'),
            success: new Audio('https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3'),
            play(name, volume = 0.3) {
                const sound = this[name].cloneNode(); // Avoid overlapping sounds
                sound.volume = volume;
                sound.play().catch(e => console.log("Audio blocked:", e));
            }
        };

        // Particle System
        function spawnParticles(x, y, color = '#FFD700', count = 5) {
            if (isMobile()) count = Math.min(3, count); // Reduce particles on mobile
            
            for (let i = 0; i < count; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                const size = Math.random() * 8 + 2;
                particle.style.width = `${size}px`;
                particle.style.height = `${size}px`;
                particle.style.background = color;
                particle.style.left = `${x}px`;
                particle.style.top = `${y}px`;
                
                document.body.appendChild(particle);
                
                // Animate
                const angle = Math.random() * Math.PI * 2;
                const speed = Math.random() * 3 + 1;
                const lifetime = Math.random() * 1000 + 500;
                
                let startTime = Date.now();
                const updateParticle = () => {
                    const elapsed = Date.now() - startTime;
                    const progress = elapsed / lifetime;
                    
                    if (progress >= 1) {
                        particle.remove();
                        return;
                    }
                    
                    const distance = speed * elapsed * 0.1;
                    particle.style.transform = `translate(-50%, -50%) translate(${Math.cos(angle) * distance}px, ${Math.sin(angle) * distance}px)`;
                    particle.style.opacity = 1 - progress;
                    requestAnimationFrame(updateParticle);
                };
                
                requestAnimationFrame(updateParticle);
            }
        }

        // Translation dictionary
        const translations = {
            en: {
                welcome: "Welcome to Physical Physics",
                subtitle: "Let's get started with a few quick settings",
                language: "Select Language",
                tutorial: "Quick Tutorial",
                step1: "Tap on the dock icons to select different shapes to create",
                step2: "Tap anywhere on the canvas to place your selected shape",
                step3: "Long-press on objects to enter edit mode",
                step4: "Select the trash icon to delete objects by tapping on them",
                step5: "Use the menu button to access the roulette and shop",
                skip: "Skip",
                continue: "Continue",
                loading: "Loading Physical Physics",
                ready: "Ready!",
                menuTitle: "Physical Physics - By KVRELIA",
                box: "Box",
                circle: "Circle",
                triangle: "Triangle",
                hexagon: "Hexagon",
                static: "Static Block",
                paused: "Paused",
                resume: "Resume",
                pause: "Pause",
                save: "Save",
                load: "Load",
                sceneSaved: "Scene saved successfully!",
                sceneLoaded: "Scene loaded successfully!",
                loadError: "Error loading scene",
                rouletteTitle: "Roulette",
                lootboxTitle: "Loot Box",
                shopTitle: "Shape Shop",
                shopBalance: "Your Balance:",
                shopClose: "Close",
                spin: "SPIN",
                open: "OPEN",
                youWon: "You won!",
                youGot: "You got!",
                points: "points",
                yuan: "yuan"
            },
            es: {
                welcome: "Bienvenido a Physical Physics",
                subtitle: "Comencemos con algunas configuraciones rápidas",
                language: "Selecciona el idioma",
                tutorial: "Tutorial rápido",
                step1: "Toca los iconos del dock para seleccionar diferentes formas",
                step2: "Toca en cualquier lugar del lienzo para colocar tu forma seleccionada",
                step3: "Mantén presionado objetos para entrar en modo de edición",
                step4: "Selecciona el icono de basura para eliminar objetos",
                step5: "Usa el botón de menú para acceder a la ruleta y tienda",
                skip: "Saltar",
                continue: "Continuar",
                loading: "Cargando Physical Physics",
                ready: "¡Listo!",
                menuTitle: "Physical Physics - Por KVRELIA",
                box: "Caja",
                circle: "Círculo",
                triangle: "Triángulo",
                hexagon: "Hexágono",
                static: "Bloque estático",
                paused: "En pausa",
                resume: "Continuar",
                pause: "Pausa",
                save: "Guardar",
                load: "Cargar",
                sceneSaved: "Escena guardada con éxito!",
                sceneLoaded: "Escena cargada con éxito!",
                loadError: "Error al cargar escena",
                rouletteTitle: "Ruleta",
                lootboxTitle: "Caja de Botín",
                shopTitle: "Tienda de Formas",
                shopBalance: "Tu saldo:",
                shopClose: "Cerrar",
                spin: "GIRAR",
                open: "ABRIR",
                youWon: "¡Ganaste!",
                youGot: "¡Obtuviste!",
                points: "puntos",
                yuan: "yuanes"
            },
            fr: {
                welcome: "Bienvenue dans Physical Physics",
                subtitle: "Commençons avec quelques réglages rapides",
                language: "Sélectionnez la langue",
                tutorial: "Tutoriel rapide",
                step1: "Appuyez sur les icônes du dock pour sélectionner différentes formes",
                step2: "Appuyez n'importe où sur le canevas pour placer votre forme sélectionnée",
                step3: "Appuyez longuement sur les objets pour entrer en mode édition",
                step4: "Selecciona el icono poubelle pour supprimer des objets",
                step5: "Utilisez le bouton de menu pour accéder à la roulette et au magasin",
                skip: "Passer",
                continue: "Continuer",
                loading: "Chargement de Physical Physics",
                ready: "Prêt!",
                menuTitle: "Physical Physics - Par KVRELIA",
                box: "Boîte",
                circle: "Cercle",
                triangle: "Triangle",
                hexagon: "Hexagone",
                static: "Bloc statique",
                paused: "En pause",
                resume: "Reprendre",
                pause: "Pause",
                save: "Sauvegarder",
                load: "Charger",
                sceneSaved: "Scène sauvegardée avec succès!",
                sceneLoaded: "Scène chargée avec succès!",
                loadError: "Erreur lors du chargement de la scène",
                rouletteTitle: "Roulette",
                lootboxTitle: "Boîte à Butin",
                shopTitle: "Boutique de Formes",
                shopBalance: "Votre solde:",
                shopClose: "Fermer",
                spin: "TOURNER",
                open: "OUVRIR",
                youWon: "Vous avez gagné!",
                youGot: "Vous avez obtenu!",
                points: "points",
                yuan: "yuans"
            },
            de: {
                welcome: "Willkommen bei Physical Physics",
                subtitle: "Beginnen wir mit einigen schnellen Einstellungen",
                language: "Sprache auswählen",
                tutorial: "Schnellanleitung",
                step1: "Tippen Sie auf die Dock-Symbole, um verschiedene Formen auszuwählen",
                step2: "Tippen Sie auf die Leinwand, um Ihre ausgewählte Form zu platzieren",
                step3: "Halten Sie Objekte gedrückt, um den Bearbeitungsmodus zu aktivieren",
                step4: "Wählen Sie das Mülleimer-Symbol aus, um Objekte zu löschen",
                step5: "Verwenden Sie die Menütaste, um auf das Roulette und den Shop zuzugreifen",
                skip: "Überspringen",
                continue: "Weiter",
                loading: "Lade Physical Physics",
                ready: "Fertig!",
                menuTitle: "Physical Physics - Von KVRELIA",
                box: "Kasten",
                circle: "Kreis",
                triangle: "Dreieck",
                hexagon: "Sechseck",
                static: "Statischer Block",
                paused: "Pausiert",
                resume: "Fortsetzen",
                pause: "Pause",
                save: "Speichern",
                load: "Laden",
                sceneSaved: "Szene erfolgreich gespeichert!",
                sceneLoaded: "Szene erfolgreich geladen!",
                loadError: "Fehler beim Laden der Szene",
                rouletteTitle: "Roulette",
                lootboxTitle: "Lootbox",
                shopTitle: "Formen-Shop",
                shopBalance: "Ihr Guthaben:",
                shopClose: "Schließen",
                spin: "DREHEN",
                open: "ÖFFNEN",
                youWon: "Sie haben gewonnen!",
                youGot: "Sie haben erhalten!",
                points: "Punkte",
                yuan: "Yuan"
            },
            ja: {
                welcome: "Physical Physicsへようこそ",
                subtitle: "簡単な設定から始めましょう",
                language: "言語を選択",
                tutorial: "クイックチュートリアル",
                step1: "ドックアイコンをタップして作成する形状を選択",
                step2: "キャンバスをタップして選択した形状を配置",
                step3: "オブジェクトを長押しして編集モードに入る",
                step4: "ゴミ箱アイコンを選択してオブジェクトを削除",
                step5: "メニューボタンからルーレットとショップにアクセス",
                skip: "スキップ",
                continue: "続ける",
                loading: "Physical Physicsを読み込み中",
                ready: "準備完了!",
                menuTitle: "Physical Physics - KVRELIA作",
                box: "ボックス",
                circle: "円",
                triangle: "三角形",
                hexagon: "六角形",
                static: "固定ブロック",
                paused: "一時停止中",
                resume: "再開",
                pause: "一時停止",
                save: "保存",
                load: "読み込み",
                sceneSaved: "シーンを保存しました!",
                sceneLoaded: "シーンを読み込みました!",
                loadError: "シーンの読み込みエラー",
                rouletteTitle: "ルーレット",
                lootboxTitle: "ルートボックス",
                shopTitle: "形状ショップ",
                shopBalance: "残高:",
                shopClose: "閉じる",
                spin: "スピン",
                open: "開く",
                youWon: "当たりました!",
                youGot: "獲得しました!",
                points: "ポイント",
                yuan: "元"
            },
            ko: {
                welcome: "Physical Physics에 오신 것을 환영합니다",
                subtitle: "빠른 설정으로 시작해 보세요",
                language: "언어 선택",
                tutorial: "빠른 사용법",
                step1: "독 아이콘을 탭하여 만들 모양을 선택하세요",
                step2: "캔버스 아무 곳이나 탭하여 선택한 모양을 배치하세요",
                step3: "객체를 길게 눌러 편집 모드로 들어가세요",
                step4: "휴지통 아이콘을 선택하여 객체를 삭제하세요",
                step5: "메뉴 버튼에서 룰렛과 상점에 액세스하세요",
                skip: "건너뛰기",
                continue: "계속",
                loading: "Physical Physics 로드 중",
                ready: "준비 완료!",
                menuTitle: "Physical Physics - KVRELIA 제작",
                box: "상자",
                circle: "원",
                triangle: "삼각형",
                hexagon: "육각형",
                static: "고정 블록",
                paused: "일시 정지됨",
                resume: "계속하기",
                pause: "일시 정지",
                save: "저장",
                load: "불러오기",
                sceneSaved: "씬 저장 성공!",
                sceneLoaded: "씬 불러오기 성공!",
                loadError: "씬 불러오기 오류",
                rouletteTitle: "룰렛",
                lootboxTitle: "루트 박스",
                shopTitle: "모양 상점",
                shopBalance: "잔액:",
                shopClose: "닫기",
                spin: "회전",
                open: "열기",
                youWon: "당첨되었습니다!",
                youGot: "획득했습니다!",
                points: "포인트",
                yuan: "위안"
            },
            tl: {
                welcome: "Maligayang pagdating sa Physical Physics",
                subtitle: "Magsimula tayo sa ilang mabilis na setting",
                language: "Pumili ng wika",
                tutorial: "Mabilis na gabay",
                step1: "I-tap ang mga icon sa dock para pumili ng iba't ibang hugis",
                step2: "I-tap kahit saan sa canvas para ilagay ang napiling hugis",
                step3: "Pindutin ng matagas ang mga bagay para mag-edit",
                step4: "Piliin ang trash icon para burahin ang mga bagay",
                step5: "Gamitin ang menu button para ma-access ang roulette at shop",
                skip: "Laktawan",
                continue: "Magpatuloy",
                loading: "Naglo-load ng Physical Physics",
                ready: "Handa na!",
                menuTitle: "Physical Physics - Ni KVRELIA",
                box: "Kahon",
                circle: "Bilog",
                triangle: "Tatsulok",
                hexagon: "Heksagono",
                static: "Hindi gumagalaw na bloke",
                paused: "Naka-pause",
                resume: "Ipagpatuloy",
                pause: "I-pause",
                save: "I-save",
                load: "I-load",
                sceneSaved: "Tagumpay na na-save ang scene!",
                sceneLoaded: "Tagumpay na na-load ang scene!",
                loadError: "Error sa pag-load ng scene",
                rouletteTitle: "Ruleta",
                lootboxTitle: "Loot Box",
                shopTitle: "Shop ng Hugis",
                shopBalance: "Iyong balanse:",
                shopClose: "Isara",
                spin: "IKOT",
                open: "BUKSAN",
                youWon: "Nanalo ka!",
                youGot: "Nakuha mo!",
                points: "puntos",
                yuan: "yuan"
            },
            sv: {
                welcome: "Välkommen till Physical Physics",
                subtitle: "Låt oss komma igång med några snabba inställningar",
                language: "Välj språk",
                tutorial: "Snabbguide",
                step1: "Tryck på dockikoner för att välja olika former att skapa",
                step2: "Tryck var som helst på duken för att placera din valda form",
                step3: "Håll ner objekt för att gå in i redigeringsläge",
                step4: "Välj papperskorgsikonen för att ta bort objekt",
                step5: "Använd menyknappen för att komma åt roulette och butik",
                skip: "Hoppa över",
                continue: "Fortsätt",
                loading: "Laddar Physical Physics",
                ready: "Redo!",
                menuTitle: "Physical Physics - Av KVRELIA",
                box: "Låda",
                circle: "Cirkel",
                triangle: "Triangel",
                hexagon: "Hexagon",
                static: "Statiskt block",
                paused: "Pausad",
                resume: "Fortsätt",
                pause: "Pausa",
                save: "Spara",
                load: "Ladda",
                sceneSaved: "Scen sparad framgångsrikt!",
                sceneLoaded: "Scen laddad framgångsrikt!",
                loadError: "Fel vid laddning av scen",
                rouletteTitle: "Roulette",
                lootboxTitle: "Lootbox",
                shopTitle: "Formbutik",
                shopBalance: "Ditt saldo:",
                shopClose: "Stäng",
                spin: "SNURRA",
                open: "ÖPPNA",
                youWon: "Du vann!",
                youGot: "Du fick!",
                points: "poäng",
                yuan: "yuan"
            }
        };

        // Startup Sequence
        document.addEventListener('DOMContentLoaded', () => {
            try {
                const startupScreen = document.getElementById('startupScreen');
                const setupScreen = document.getElementById('setupScreen');
                const logoReplay = document.getElementById('logoReplay');
                const progressBar = document.getElementById('startupProgress');
                const progressText = document.getElementById('progressText');
                const dock = document.getElementById('dock');
                const startupVideo = document.getElementById('startupVideo');
                const replayVideo = document.getElementById('replayVideo');
                const continueButton = document.getElementById('continueButton');
                const skipButton = document.getElementById('skipButton');
                
                let progress = 0;
                
                // Ensure videos play
                function ensureVideoPlay(video) {
                    if (!video) return;
                    
                    const playPromise = video.play();
                    if (playPromise !== undefined) {
                        playPromise.catch(error => {
                            console.log("Video playback failed:", error);
                            video.style.display = 'none';
                            const fallback = video.querySelector('img');
                            if (fallback) {
                                fallback.style.display = 'block';
                                fallback.alt = 'Physical Physics Logo Fallback';
                            }
                        });
                    }
                    
                    video.addEventListener('error', () => {
                        console.error("Video error occurred");
                        video.style.display = 'none';
                        const fallback = video.querySelector('img');
                        if (fallback) fallback.style.display = 'block';
                    });
                }
                
                // Start playing videos
                ensureVideoPlay(startupVideo);
                
                function updateProgress() {
                    progress += Math.random() * 8 + 4;
                    progress = Math.min(progress, 100);
                    progressBar.style.width = `${progress}%`;
                    progressText.textContent = `${translations[selectedLanguage]?.loading || 'Loading'} ${Math.floor(progress)}%`;

                    if (progress < 100) {
                        setTimeout(updateProgress, 100 + Math.random() * 150);
                    } else {
                        progressText.textContent = translations[selectedLanguage]?.ready || 'Ready!';
                        setTimeout(() => {
                            startupScreen.style.opacity = '0';
                            setTimeout(() => {
                                startupScreen.style.display = 'none';
                                
                                // Show setup screen
                                setupScreen.style.display = 'flex';
                                setTimeout(() => {
                                    setupScreen.style.opacity = '1';
                                }, 50);
                                
                            }, 800);
                        }, 1000);
                    }
                }

                // Function to update UI translations
                function updateTranslations(lang) {
                    const t = translations[lang] || translations.en;
                    
                    // Setup screen
                    document.getElementById('setupTitle').textContent = t.welcome;
                    document.getElementById('setupSubtitle').textContent = t.subtitle;
                    document.getElementById('languageTitle').textContent = t.language;
                    document.getElementById('tutorialTitle').textContent = t.tutorial;
                    document.getElementById('tutorialStep1').textContent = t.step1;
                    document.getElementById('tutorialStep2').textContent = t.step2;
                    document.getElementById('tutorialStep3').textContent = t.step3;
                    document.getElementById('tutorialStep4').textContent = t.step4;
                    document.getElementById('tutorialStep5').textContent = t.step5;
                    skipButton.textContent = t.skip;
                    continueButton.textContent = t.continue;
                    
                    // Menu title
                    document.getElementById('menuTitle').textContent = t.menuTitle;
                    
                    // Progress text
                    if (progressText) {
                        progressText.textContent = `${t.loading} ${Math.floor(progress)}%`;
                    }
                    
                    // Pause overlay
                    document.querySelector('.pause-overlay h2').textContent = t.paused;
                    document.getElementById('resumeBtn').textContent = t.resume;
                    
                    // Save/Load buttons
                    document.getElementById('saveBtn').textContent = t.save;
                    document.getElementById('loadBtn').textContent = t.load;
                    
                    // Roulette
                    document.getElementById('spinRoulette').textContent = t.spin;
                    document.getElementById('rouletteResultTitle').textContent = t.youWon;
                    
                    // Loot Box
                    document.getElementById('lootboxResultTitle').textContent = t.youGot;
                    
                    // Shop
                    document.querySelector('.shop-header h2').textContent = t.shopTitle;
                    document.querySelector('.shop-balance div:first-child').textContent = t.shopBalance;
                    document.getElementById('shopCloseBtn').textContent = t.shopClose;
                    
                    // Update shop items
                    updateShopItems();
                }

                // Language selection
                document.querySelectorAll('.language-option').forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        document.querySelectorAll('.language-option').forEach(opt => 
                            opt.classList.remove('selected'));
                        option.classList.add('selected');
                        selectedLanguage = option.dataset.lang;
                        updateTranslations(selectedLanguage);
                    });
                });
                
                function proceedToLogoReplay() {
                    setupScreen.style.opacity = '0';
                    setTimeout(() => {
                        setupScreen.style.display = 'none';
                        
                        // Show logo replay
                        logoReplay.style.display = 'flex';
                        setTimeout(() => {
                            logoReplay.style.opacity = '1';
                            
                            // Play the video once
                            replayVideo.loop = false;
                            replayVideo.currentTime = 0;
                            ensureVideoPlay(replayVideo);
                            
                            // When video ends, transition to main app
                            replayVideo.addEventListener('ended', () => {
                                logoReplay.style.opacity = '0';
                                setTimeout(() => {
                                    logoReplay.style.display = 'none';
                                    initPhysics();
                                    initDock();
                                    initTooltips();
                                    initEditControls();
                                    initRouletteSystem();
                                    initLootboxSystem();
                                    initShopSystem();
                                    initPauseSystem();
                                    initSaveLoadSystem();
                                    initTouchControls();
                                    setTimeout(() => {
                                        // Show all controls after setup is complete
                                        document.querySelector('.menu-bar').style.display = 'flex';
                                        document.querySelector('.menu-button').style.display = 'flex';
                                        document.getElementById('saveLoadControls').style.display = 'flex';
                                        
                                        // Modified dock initialization
                                        const dock = document.getElementById('dock');
                                        dock.style.display = 'flex';
                                        setTimeout(() => {
                                            dock.classList.add('visible');
                                            
                                            // Force a reflow to ensure the dock renders properly
                                            void dock.offsetWidth;
                                            
                                            // Adjust dock position if needed
                                            if (window.innerWidth > window.innerHeight) {
                                                // Landscape mode
                                                dock.style.bottom = '10px';
                                            }
                                        }, 300);
                                    }, 300);
                                }, 800);
                            }, { once: true });
                            
                            // Fallback in case video doesn't fire ended event
                            setTimeout(() => {
                                if (logoReplay.style.opacity === '1') {
                                    logoReplay.style.opacity = '0';
                                    setTimeout(() => {
                                        logoReplay.style.display = 'none';
                                        initPhysics();
                                        initDock();
                                        initTooltips();
                                        initEditControls();
                                        initRouletteSystem();
                                        initLootboxSystem();
                                        initShopSystem();
                                        initPauseSystem();
                                        initSaveLoadSystem();
                                        initTouchControls();
                                        setTimeout(() => {
                                            // Show all controls after setup is complete
                                            document.querySelector('.menu-bar').style.display = 'flex';
                                            document.querySelector('.menu-button').style.display = 'flex';
                                            document.getElementById('saveLoadControls').style.display = 'flex';
                                            
                                            // Modified dock initialization
                                            const dock = document.getElementById('dock');
                                            dock.style.display = 'flex';
                                            setTimeout(() => {
                                                dock.classList.add('visible');
                                                
                                                // Force a reflow to ensure the dock renders properly
                                                void dock.offsetWidth;
                                                
                                                // Adjust dock position if needed
                                                if (window.innerWidth > window.innerHeight) {
                                                    // Landscape mode
                                                    dock.style.bottom = '10px';
                                                }
                                            }, 300);
                                        }, 300);
                                    }, 800);
                                }
                            }, 5000); // 5 second fallback
                        }, 50);
                    }, 800);
                }

                // Skip button handler
                skipButton.addEventListener('click', proceedToLogoReplay);
                
                // Continue button handler
                continueButton.addEventListener('click', proceedToLogoReplay);
                
                // Start with English translations
                updateTranslations('en');
                
                // Start progress immediately
                updateProgress();
            } catch (error) {
                console.error("Initialization error:", error);
                document.body.innerHTML = `
                    <div style="padding: 20px; color: red;">
                        <h1>Application Error</h1>
                        <p>Sorry, the app failed to initialize. Please refresh the page.</p>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        });

        // Physics Engine with mobile optimizations
        function initPhysics() {
            try {
                // Create engine with better physics settings
                engine = Engine.create({
                    enableSleeping: true,
                    gravity: { x: 0, y: 1 },
                    positionIterations: isMobile() ? 6 : 8,
                    velocityIterations: isMobile() ? 4 : 6,
                    constraintIterations: 3,
                    enableSAT: true,
                    timing: {
                        timeScale: 1,
                        timestamp: 0
                    }
                });
                
                const canvas = document.getElementById('canvas');
                if (!canvas) throw new Error("Canvas element not found");
                
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 44;

                // Create renderer
                render = Render.create({
                    canvas: canvas,
                    engine: engine,
                    options: {
                        width: canvas.width,
                        height: canvas.height,
                        wireframes: false,
                        background: 'transparent',
                        showSleeping: false,
                        showCollisions: false,
                        showVelocity: false
                    }
                });

                // Create walls with better physics properties
                const wallOptions = { 
                    isStatic: true,
                    friction: 0.3,
                    frictionStatic: 0.5,
                    restitution: 0.2,
                    render: { 
                        fillStyle: '#8E8E93',
                        visible: true
                    } 
                };

                const walls = [
                    Bodies.rectangle(
                        canvas.width/2, 
                        canvas.height + 20,
                        canvas.width * 1.5,
                        80,
                        wallOptions
                    ),
                    Bodies.rectangle(
                        -30,
                        canvas.height/2, 
                        60,
                        canvas.height * 1.2,
                        wallOptions
                    ),
                    Bodies.rectangle(
                        canvas.width + 30,
                        canvas.height/2, 
                        60,
                        canvas.height * 1.2,
                        wallOptions
                    )
                ];

                Composite.add(engine.world, walls);
                Render.run(render);
                
                // Create runner with fixed timestep
                runner = Runner.create({
                    delta: 1000 / 60,  // 60 FPS
                    isFixed: true
                });
                Runner.run(runner, engine);

                // Collision sound & particles
                Matter.Events.on(engine, 'collisionStart', (event) => {
                    event.pairs.forEach(pair => {
                        // Play sound for significant collisions
                        if (pair.bodyA.speed > 0.5 || pair.bodyB.speed > 0.5) {
                            audio.play('thud', 0.1 + Math.min(0.4, pair.collision.depth * 0.05));
                        }

                        // Spawn particles at collision point
                        const avgX = (pair.bodyA.position.x + pair.bodyB.position.x) / 2;
                        const avgY = (pair.bodyA.position.y + pair.bodyB.position.y) / 2;
                        spawnParticles(avgX, avgY, '#FFD700', 5);
                    });
                });

                // Click Handling - Modified to create only one object
                const clickHandler = (e) => {
                    if (isProcessingClick || (editMode && !moveMode)) return;
                    isProcessingClick = true;
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;

                    if (currentMode === 'delete') {
                        const found = Query.point(bodies, {x, y});
                        if (found.length) {
                            removeBody(found[0]);
                        }
                    } else {
                        // Create only one object at the click position
                        const body = createBody(x, y);
                        if (body) {
                            audio.play('click');
                            spawnParticles(x, y, body.render.fillStyle, 3);
                        }
                    }
                    
                    setTimeout(() => {
                        isProcessingClick = false;
                    }, 100);
                };
                canvas.addEventListener('click', clickHandler);

                // Double click to enter edit mode (desktop)
                if (!isMobile()) {
                    const dblClickHandler = (e) => {
                        if (editMode) return;
                        
                        const rect = canvas.getBoundingClientRect();
                        const x = e.clientX - rect.left;
                        const y = e.clientY - rect.top;
                        
                        const found = Query.point(bodies, {x, y});
                        if (found.length) {
                            enterEditMode(found[0]);
                        }
                    };
                    canvas.addEventListener('dblclick', dblClickHandler);
                }
            } catch (error) {
                console.error("Physics initialization error:", error);
                showNotification("Failed to initialize physics engine", true);
            }
        }

        function removeBody(body) {
            try {
                Composite.remove(engine.world, body);
                const index = bodies.indexOf(body);
                if (index > -1) {
                    bodies.splice(index, 1);
                }
                // Nullify references
                if (selectedBody === body) selectedBody = null;
            } catch (error) {
                console.error("Error removing body:", error);
            }
        }

        function enterEditMode(body) {
            try {
                editMode = true;
                selectedBody = body;
                originalBodyState = {
                    position: { x: body.position.x, y: body.position.y },
                    size: body.bounds.max.x - body.bounds.min.x,
                    mass: body.mass,
                    restitution: body.restitution,
                    friction: body.friction,
                    isStatic: body.isStatic
                };

                // Set slider value
                document.getElementById('sizeSlider').value = originalBodyState.size;
                
                // Show edit controls
                const editControls = document.getElementById('editControls');
                editControls.style.display = 'flex';
                
                // Position controls for mobile
                if (isMobile()) {
                    editControls.style.bottom = '80px';
                    editControls.style.width = '90%';
                }
                
                // Make body static while editing
                Body.setStatic(body, true);
                
                // Add touch move handler for mobile
                if (isMobile()) {
                    const moveHandler = (e) => {
                        if (!editMode || !selectedBody) return;
                        
                        const touch = e.touches[0];
                        const rect = canvas.getBoundingClientRect();
                        const x = touch.clientX - rect.left;
                        const y = touch.clientY - rect.top;
                        
                        Body.setPosition(selectedBody, { x, y });
                        e.preventDefault();
                    };
                    
                    canvas.addEventListener('touchmove', moveHandler, { passive: false });
                    selectedBody._moveHandler = moveHandler;
                }
            } catch (error) {
                console.error("Error entering edit mode:", error);
            }
        }

        function exitEditMode(saveChanges) {
            if (!editMode) return;
            
            try {
                if (saveChanges && selectedBody) {
                    // Apply changes
                    const newSize = parseInt(document.getElementById('sizeSlider').value);
                    resizeBody(selectedBody, newSize);
                } else if (selectedBody) {
                    // Revert changes
                    Body.setPosition(selectedBody, originalBodyState.position);
                    if (originalBodyState.size !== (selectedBody.bounds.max.x - selectedBody.bounds.min.x)) {
                        resizeBody(selectedBody, originalBodyState.size);
                    }
                    Body.setMass(selectedBody, originalBodyState.mass);
                    Body.set(selectedBody, {
                        restitution: originalBodyState.restitution,
                        friction: originalBodyState.friction,
                        frictionStatic: originalBodyState.friction,
                        isStatic: originalBodyState.isStatic
                    });
                }
                
                // Restore body physics
                if (selectedBody) {
                    Body.setStatic(selectedBody, false);
                    
                    // Remove touch move handler if it exists
                    if (selectedBody._moveHandler) {
                        canvas.removeEventListener('touchmove', selectedBody._moveHandler);
                        delete selectedBody._moveHandler;
                    }
                }
                
                // Reset edit mode
                editMode = false;
                moveMode = false;
                resizeMode = false;
                selectedBody = null;
                originalBodyState = null;
                
                // Hide edit controls
                document.getElementById('editControls').style.display = 'none';
            } catch (error) {
                console.error("Error exiting edit mode:", error);
            }
        }

        function resizeBody(body, newSize) {
            try {
                const scale = newSize / (body.bounds.max.x - body.bounds.min.x);
                Body.scale(body, scale, scale);
            } catch (error) {
                console.error("Error resizing body:", error);
            }
        }

        function createBody(x, y, type = currentMode) {
            try {
                const size = 30 + Math.random() * 20;
                let body;
                let objectName = '';

                // Enhanced physics properties for more realistic behavior
                const commonProps = {
                    friction: 0.3,
                    frictionStatic: 0.5,
                    frictionAir: 0.01,
                    restitution: 0.4,
                    density: 0.001,
                    slop: 0.5,
                    collisionFilter: {
                        group: 0,
                        category: 0x0001,
                        mask: 0xFFFFFFFF
                    },
                    sleepThreshold: 60, // Higher threshold to prevent premature sleeping
                    timeScale: 1
                };

                // Get current skin for the type
                const skin = currentSkins[type] || 'default';
                
                switch(type) {
                    case 'box':
                        body = Bodies.rectangle(x, y, size, size, {
                            ...commonProps,
                            chamfer: { radius: 2 },
                            render: { 
                                fillStyle: skin === 'gold' ? '#FFD700' : 
                                          skin === 'wooden' ? '#8B4513' : '#007AFF',
                                strokeStyle: skin === 'gold' ? '#FFA500' : 
                                             skin === 'wooden' ? '#5D2906' : '#0055CC',
                                lineWidth: skin === 'wooden' ? 1 : 0
                            }
                        });
                        
                        // Add glow or texture effects
                        if (skin === 'gold') {
                            body.render.customClass = 'gold-glow';
                        } else if (skin === 'wooden') {
                            body.render.customClass = 'wooden-texture';
                        }
                        
                        objectName = translations[selectedLanguage]?.box || 'Box';
                        break;
                        
                    case 'circle':
                        body = Bodies.circle(x, y, size/2, {
                            ...commonProps,
                            render: { 
                                fillStyle: skin === 'gold' ? '#FFD700' : 
                                          skin === 'silver' ? '#C0C0C0' : '#FF3B30',
                                strokeStyle: skin === 'gold' ? '#FFA500' : 
                                             skin === 'silver' ? '#A0A0A0' : '#CC1A00',
                                lineWidth: 0
                            }
                        });
                        
                        // Add glow effects
                        if (skin === 'gold') {
                            body.render.customClass = 'gold-glow';
                        } else if (skin === 'silver') {
                            body.render.customClass = 'silver-glow';
                        }
                        
                        objectName = translations[selectedLanguage]?.circle || 'Circle';
                        break;
                        
                    case 'triangle':
                        const triangleVertices = [
                            { x: 0, y: -size/2 },
                            { x: size/2, y: size/2 },
                            { x: -size/2, y: size/2 }
                        ];
                        body = Bodies.fromVertices(x, y, [triangleVertices], {
                            ...commonProps,
                            render: { 
                                fillStyle: skin === 'gold' ? '#FFD700' : 
                                          skin === 'crystal' ? '#00FFFF' : '#FF9500',
                                strokeStyle: skin === 'gold' ? '#FFA500' : 
                                             skin === 'crystal' ? '#00BFFF' : '#E57C00',
                                lineWidth: skin === 'crystal' ? 1 : 0
                            }
                        });
                        
                        // Add glow effects
                        if (skin === 'gold') {
                            body.render.customClass = 'gold-glow';
                        } else if (skin === 'crystal') {
                            body.render.customClass = 'crystal-glow';
                        }
                        
                        objectName = translations[selectedLanguage]?.triangle || 'Triangle';
                        break;
                        
                    case 'hexagon':
                        const hexagonVertices = [];
                        const sides = 6;
                        const radius = size/1.5;
                        for (let i = 0; i < sides; i++) {
                            const angle = (Math.PI * 2 * i) / sides - Math.PI/6;
                            hexagonVertices.push({
                                x: radius * Math.cos(angle),
                                y: radius * Math.sin(angle)
                            });
                        }
                        body = Bodies.fromVertices(x, y, [hexagonVertices], {
                            ...commonProps,
                            render: { 
                                fillStyle: skin === 'gold' ? '#FFD700' : 
                                          skin === 'neon' ? '#FF00FF' : '#FF69B4',
                                strokeStyle: skin === 'gold' ? '#FFA500' : 
                                             skin === 'neon' ? '#9400D3' : '#FF1493',
                                lineWidth: 2
                            }
                        });
                        
                        // Add glow effects
                        if (skin === 'gold') {
                            body.render.customClass = 'gold-glow';
                        } else if (skin === 'neon') {
                            body.render.customClass = 'neon-glow';
                        }
                        
                        objectName = translations[selectedLanguage]?.hexagon || 'Hexagon';
                        break;
                        
                    case 'static':
                        body = Bodies.rectangle(x, y, size, size, {
                            isStatic: true,
                            friction: 0.5,
                            frictionStatic: 0.8,
                            render: { fillStyle: '#34C759' }
                        });
                        objectName = translations[selectedLanguage]?.static || 'Static Block';
                        break;
                }

                if (body) {
                    body.tooltipName = objectName;
                    Composite.add(engine.world, body);
                    bodies.push(body);
                    
                    // Wake up all bodies when a new one is added to prevent stacking issues
                    bodies.forEach(b => {
                        if (!b.isStatic) {
                            Body.setSleeping(b, false);
                        }
                    });
                    
                    return body;
                }
                return null;
            } catch (error) {
                console.error("Error creating body:", error);
                return null;
            }
        }

        // Dock System with mobile optimizations
        function initDock() {
            try {
                const dock = document.getElementById('dock');
                if (!dock) return;
                
                let isDragging = false;
                let startX, startY, startLeft, startTop;

                // Load saved position
                const savedPos = localStorage.getItem('dockPos');
                if (savedPos) {
                    const pos = JSON.parse(savedPos);
                    dock.style.left = `${pos.x}px`;
                    dock.style.bottom = `${pos.y}px`;
                    dock.style.transform = 'none';
                }

                const mouseDownHandler = (e) => {
                    if (e.target.classList.contains('dock-item')) return;
                    
                    isDragging = true;
                    const rect = dock.getBoundingClientRect();
                    startX = e.clientX || e.touches[0].clientX;
                    startY = e.clientY || e.touches[0].clientY;
                    startLeft = rect.left;
                    startTop = rect.top;
                    
                    dock.style.cursor = 'grabbing';
                    e.preventDefault();
                };

                const mouseMoveHandler = (e) => {
                    if (!isDragging) return;

                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    
                    if (!clientX || !clientY) return;

                    const dx = clientX - startX;
                    const dy = clientY - startY;

                    let newLeft = startLeft + dx;
                    let newTop = startTop + dy;

                    // Boundary constraints
                    const maxX = window.innerWidth - dock.offsetWidth;
                    const maxY = window.innerHeight - dock.offsetHeight;

                    newLeft = Math.max(0, Math.min(newLeft, maxX));
                    newTop = Math.max(0, Math.min(newTop, maxY));

                    dock.style.left = `${newLeft}px`;
                    dock.style.top = `${newTop}px`;
                    dock.style.bottom = 'auto';
                    dock.style.transform = 'none';
                    
                    e.preventDefault();
                };

                const mouseUpHandler = () => {
                    if (isDragging) {
                        isDragging = false;
                        dock.style.cursor = 'grab';
                        
                        const rect = dock.getBoundingClientRect();
                        localStorage.setItem('dockPos', JSON.stringify({
                            x: rect.left,
                            y: window.innerHeight - rect.bottom
                        }));
                    }
                };

                // Touch events
                dock.addEventListener('touchstart', mouseDownHandler, { passive: false });
                document.addEventListener('touchmove', mouseMoveHandler, { passive: false });
                document.addEventListener('touchend', mouseUpHandler, { passive: false });
                
                // Mouse events
                dock.addEventListener('mousedown', mouseDownHandler);
                document.addEventListener('mousemove', mouseMoveHandler);
                document.addEventListener('mouseup', mouseUpHandler);

                // Mode Selection
                document.querySelectorAll('.dock-item').forEach(item => {
                    item.addEventListener('click', () => {
                        if (editMode) return;
                        
                        // Handle pause mode separately
                        if (item.dataset.mode === 'pause') {
                            togglePause();
                            return;
                        }
                        
                        document.querySelectorAll('.dock-item').forEach(i => 
                            i.classList.remove('active'));
                        item.classList.add('active');
                        currentMode = item.dataset.mode;
                    });
                });
            } catch (error) {
                console.error("Dock initialization error:", error);
            }
        }

        // Tooltip System
        function initTooltips() {
            try {
                const tooltip = document.getElementById('tooltip');
                const canvas = document.getElementById('canvas');
                if (!tooltip || !canvas) return;

                function updateTooltip(e) {
                    if (!engine || editMode) return;
                    
                    const clientX = e.clientX || (e.touches && e.touches[0].clientX);
                    const clientY = e.clientY || (e.touches && e.touches[0].clientY);
                    
                    if (!clientX || !clientY) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    const mouseX = clientX - rect.left;
                    const mouseY = clientY - rect.top;
                    
                    // Find body under mouse
                    const body = Query.point(bodies, {x: mouseX, y: mouseY})[0];
                    
                    if (body && body.tooltipName) {
                        // Position tooltip above the mouse
                        tooltip.textContent = body.tooltipName;
                        tooltip.style.left = `${clientX}px`;
                        tooltip.style.top = `${clientY - 30}px`;
                        tooltip.classList.add('visible');
                    } else {
                        tooltip.classList.remove('visible');
                    }
                }

                canvas.addEventListener('mousemove', updateTooltip);
                canvas.addEventListener('touchmove', updateTooltip, { passive: false });
                canvas.addEventListener('mouseout', () => {
                    tooltip.classList.remove('visible');
                });
                canvas.addEventListener('touchend', () => {
                    tooltip.classList.remove('visible');
                });
            } catch (error) {
                console.error("Tooltip initialization error:", error);
            }
        }

        // Initialize edit controls
        function initEditControls() {
            try {
                const moveBtn = document.getElementById('moveBtn');
                const resizeBtn = document.getElementById('resizeBtn');
                const confirmBtn = document.getElementById('confirmEditBtn');
                const cancelBtn = document.getElementById('cancelEditBtn');
                const sizeSlider = document.getElementById('sizeSlider');
                const canvas = document.getElementById('canvas');
                if (!moveBtn || !resizeBtn || !confirmBtn || !cancelBtn || !sizeSlider || !canvas) return;

                moveBtn.addEventListener('click', () => {
                    moveMode = !moveMode;
                    resizeMode = false;
                    moveBtn.classList.toggle('active', moveMode);
                    resizeBtn.classList.remove('active');
                });

                resizeBtn.addEventListener('click', () => {
                    resizeMode = !resizeMode;
                    moveMode = false;
                    resizeBtn.classList.toggle('active', resizeMode);
                    moveBtn.classList.remove('active');
                });

                confirmBtn.addEventListener('click', () => {
                    exitEditMode(true);
                });

                cancelBtn.addEventListener('click', () => {
                    exitEditMode(false);
                });

                // Handle moving the object (desktop)
                const moveHandler = (e) => {
                    if (!editMode || !moveMode || !selectedBody) return;
                    
                    const rect = canvas.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    Body.setPosition(selectedBody, { x, y });
                };
                canvas.addEventListener('mousemove', moveHandler);

                // Update size in real-time
                sizeSlider.addEventListener('input', () => {
                    if (!editMode || !resizeMode || !selectedBody) return;
                    resizeBody(selectedBody, parseInt(sizeSlider.value));
                });
            } catch (error) {
                console.error("Edit controls initialization error:", error);
            }
        }

        // Initialize Save/Load System
        function initSaveLoadSystem() {
            try {
                const saveBtn = document.getElementById('saveBtn');
                const loadBtn = document.getElementById('loadBtn');
                
                if (!saveBtn || !loadBtn) return;

                saveBtn.addEventListener('click', saveScene);
                loadBtn.addEventListener('click', loadScene);
            } catch (error) {
                console.error("Save/Load system initialization error:", error);
            }
        }

        function saveScene() {
            try {
                const sceneData = {
                    bodies: bodies.map(body => ({
                        type: body.tooltipName.toLowerCase().replace(' ', '_'),
                        position: { x: body.position.x, y: body.position.y },
                        size: body.bounds.max.x - body.bounds.min.x,
                        options: {
                            render: { 
                                fillStyle: body.render.fillStyle,
                                strokeStyle: body.render.strokeStyle,
                                lineWidth: body.render.lineWidth,
                                customClass: body.render.customClass
                            },
                            isStatic: body.isStatic,
                            mass: body.mass,
                            restitution: body.restitution,
                            friction: body.friction
                        }
                    })),
                    currentSkins: currentSkins,
                    points: points,
                    yuan: yuan,
                    unlockedShapes: unlockedShapes
                };
                localStorage.setItem('physicalPhysicsScene', JSON.stringify(sceneData));
                showNotification(translations[selectedLanguage]?.sceneSaved || 'Scene saved successfully!');
            } catch (error) {
                console.error("Error saving scene:", error);
                showNotification(translations[selectedLanguage]?.loadError || 'Error saving scene', true);
            }
        }

        function loadScene() {
            try {
                const savedData = localStorage.getItem('physicalPhysicsScene');
                if (!savedData) {
                    showNotification("No saved scene found", true);
                    return;
                }
                
                const sceneData = JSON.parse(savedData);
                
                // Clear current scene
                Composite.clear(engine.world, false);
                bodies.length = 0;
                
                // Recreate bodies
                sceneData.bodies.forEach(savedBody => {
                    const body = createBody(
                        savedBody.position.x, 
                        savedBody.position.y, 
                        savedBody.type.replace('_', ' ')
                    );
                    if (body) {
                        if (savedBody.size) {
                            resizeBody(body, savedBody.size);
                        }
                        if (savedBody.options) {
                            Body.set(body, {
                                isStatic: savedBody.options.isStatic,
                                mass: savedBody.options.mass,
                                restitution: savedBody.options.restitution,
                                friction: savedBody.options.friction,
                                frictionStatic: savedBody.options.friction
                            });
                            if (body.render) {
                                body.render.fillStyle = savedBody.options.render.fillStyle;
                                body.render.strokeStyle = savedBody.options.render.strokeStyle;
                                body.render.lineWidth = savedBody.options.render.lineWidth;
                                if (savedBody.options.render.customClass) {
                                    body.render.customClass = savedBody.options.render.customClass;
                                }
                            }
                        }
                    }
                });
                
                // Load currency and skins
                if (sceneData.currentSkins) {
                    Object.assign(currentSkins, sceneData.currentSkins);
                }
                if (sceneData.points !== undefined) {
                    points = sceneData.points;
                }
                if (sceneData.yuan !== undefined) {
                    yuan = sceneData.yuan;
                }
                if (sceneData.unlockedShapes) {
                    unlockedShapes.length = 0;
                    sceneData.unlockedShapes.forEach(shape => unlockedShapes.push(shape));
                }
                
                showNotification(translations[selectedLanguage]?.sceneLoaded || 'Scene loaded successfully!');
            } catch (error) {
                console.error("Error loading scene:", error);
                showNotification(translations[selectedLanguage]?.loadError || 'Error loading scene', true);
            }
        }

        function showNotification(message, isError = false) {
            try {
                const notification = document.createElement('div');
                notification.className = `notification ${isError ? 'error' : 'success'}`;
                notification.textContent = message;
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.classList.add('fade-out');
                    setTimeout(() => notification.remove(), 500);
                }, 3000);
            } catch (error) {
                console.error("Error showing notification:", error);
            }
        }

        // Initialize Roulette System
        function initRouletteSystem() {
            try {
                const menuButton = document.getElementById('menuButton');
                const menuOptions = document.getElementById('menuOptions');
                const rouletteBtn = document.getElementById('rouletteBtn');
                const rouletteContainer = document.getElementById('rouletteContainer');
                const spinRoulette = document.getElementById('spinRoulette');
                const rouletteResult = document.getElementById('rouletteResult');
                const rouletteCloseBtn = document.getElementById('rouletteCloseBtn');
                
                if (!menuButton || !menuOptions || !rouletteBtn || !rouletteContainer || 
                    !spinRoulette || !rouletteResult || !rouletteCloseBtn) {
                    throw new Error("Roulette elements not found");
                }
                
                // Create roulette sections
                createRouletteSections();
                
                // Toggle menu options
                menuButton.addEventListener('click', (e) => {
                    e.stopPropagation();
                    menuOptions.style.display = menuOptions.style.display === 'flex' ? 'none' : 'flex';
                });
                
                // Roulette button
                rouletteBtn.addEventListener('click', () => {
                    menuOptions.style.display = 'none';
                    rouletteContainer.style.display = 'flex';
                    rouletteResult.style.display = 'none';
                });
                
                // Spin roulette
                spinRoulette.addEventListener('click', spinRouletteWheel);
                
                // Close roulette
                rouletteCloseBtn.addEventListener('click', () => {
                    rouletteContainer.style.display = 'none';
                });
                
                // Close menu when clicking outside
                document.addEventListener('click', (e) => {
                    if (!menuOptions.contains(e.target) && e.target !== menuButton) {
                        menuOptions.style.display = 'none';
                    }
                });
            } catch (error) {
                console.error("Roulette system initialization error:", error);
            }
        }
        
        function createRouletteSections() {
            try {
                const rouletteWheel = document.getElementById('rouletteWheel');
                if (!rouletteWheel) return;
                
                // Clear existing sections
                while (rouletteWheel.children.length > 2) {
                    rouletteWheel.removeChild(rouletteWheel.lastChild);
                }
                
                // Roulette sections with different rewards
                const sections = [
                    { color: '#FF3B30', reward: 50, text: '50 points' },
                    { color: '#007AFF', reward: 100, text: '100 points' },
                    { color: '#34C759', reward: 150, text: '150 points' },
                    { color: '#FF9500', reward: 200, text: '200 points' },
                    { color: '#5856D6', reward: 10, text: '10 yuan' },
                    { color: '#FF2D55', reward: 20, text: '20 yuan' },
                    { color: '#FFCC00', reward: 5, text: '5 yuan' },
                    { color: '#5AC8FA', reward: 50, text: '50 points' }
                ];
                
                // Create sections
                sections.forEach((section, i) => {
                    const sectionEl = document.createElement('div');
                    sectionEl.className = 'roulette-section';
                    sectionEl.style.transform = `rotate(${i * (360 / sections.length)}deg)`;
                    sectionEl.style.background = section.color;
                    
                    const textEl = document.createElement('div');
                    textEl.textContent = section.text;
                    textEl.style.transform = `rotate(${45}deg)`;
                    textEl.style.fontSize = '12px';
                    
                    sectionEl.appendChild(textEl);
                    rouletteWheel.insertBefore(sectionEl, rouletteWheel.lastChild);
                });
            } catch (error) {
                console.error("Error creating roulette sections:", error);
            }
        }
        
        function spinRouletteWheel() {
            try {
                const spinRoulette = document.getElementById('spinRoulette');
                const rouletteWheel = document.getElementById('rouletteWheel');
                const rouletteResult = document.getElementById('rouletteResult');
                const resultTitle = document.getElementById('rouletteResultTitle');
                const resultText = document.getElementById('rouletteResultText');
                
                if (!spinRoulette || !rouletteWheel || !rouletteResult) return;
                
                // Disable button during spin
                spinRoulette.style.pointerEvents = 'none';
                spinRoulette.textContent = '...';
                
                // Highlight the wheel
                rouletteWheel.style.boxShadow = '0 0 30px rgba(255, 215, 0, 0.7)';
                
                // Random spin duration and rotation
                const spinDuration = 3000 + Math.random() * 2000; // 3-5 seconds
                const rotations = 5 + Math.random() * 3; // 5-8 full rotations
                const finalRotation = 360 * rotations + Math.floor(Math.random() * 360);
                
                // Apply spin animation
                rouletteWheel.style.transition = `transform ${spinDuration}ms cubic-bezier(0.17, 0.67, 0.21, 0.99)`;
                rouletteWheel.style.transform = `rotate(${-finalRotation}deg)`;
                
                // Determine result after spin
                setTimeout(() => {
                    // Calculate which section is at the top
                    const sectionAngle = 360 - (finalRotation % 360);
                    const sectionIndex = Math.floor(sectionAngle / (360 / 8));
                    
                    // Get the reward
                    let reward;
                    let rewardType;
                    let rewardText;
                    
                    switch(sectionIndex) {
                        case 0: reward = 50; rewardType = 'points'; rewardText = '50 points'; break;
                        case 1: reward = 100; rewardType = 'points'; rewardText = '100 points'; break;
                        case 2: reward = 150; rewardType = 'points'; rewardText = '150 points'; break;
                        case 3: reward = 200; rewardType = 'points'; rewardText = '200 points'; break;
                        case 4: reward = 10; rewardType = 'yuan'; rewardText = '10 yuan'; break;
                        case 5: reward = 20; rewardType = 'yuan'; rewardText = '20 yuan'; break;
                        case 6: reward = 5; rewardType = 'yuan'; rewardText = '5 yuan'; break;
                        case 7: reward = 50; rewardType = 'points'; rewardText = '50 points'; break;
                    }
                    
                    // Highlight the winning section
                    const sections = document.querySelectorAll('.roulette-section');
                    sections[sectionIndex].classList.add('highlight');
                    
                    // Apply reward
                    if (rewardType === 'points') {
                        points += reward;
                    } else {
                        yuan += reward;
                    }
                    
                    // Show result
                    resultText.textContent = rewardText;
                    rouletteResult.style.display = 'flex';
                    
                    // Play sound and particles
                    audio.play('success');
                    spawnParticles(
                        rouletteWheel.offsetLeft + rouletteWheel.offsetWidth / 2,
                        rouletteWheel.offsetTop + rouletteWheel.offsetHeight / 2,
                        '#FFD700',
                        20
                    );
                    
                    // Reset wheel
                    setTimeout(() => {
                        sections[sectionIndex].classList.remove('highlight');
                        rouletteWheel.style.transition = 'none';
                        rouletteWheel.style.transform = 'rotate(0deg)';
                        rouletteWheel.style.boxShadow = '0 10px 30px rgba(0, 0, 0, 0.5)';
                        setTimeout(() => {
                            spinRoulette.style.pointerEvents = 'auto';
                            spinRoulette.textContent = translations[selectedLanguage]?.spin || 'SPIN';
                        }, 50);
                    }, 2000);
                }, spinDuration);
            } catch (error) {
                console.error("Error spinning roulette:", error);
                const spinRoulette = document.getElementById('spinRoulette');
                if (spinRoulette) {
                    spinRoulette.style.pointerEvents = 'auto';
                    spinRoulette.textContent = translations[selectedLanguage]?.spin || 'SPIN';
                }
            }
        }

        // Initialize Loot Box System
        function initLootboxSystem() {
            try {
                const menuOptions = document.getElementById('menuOptions');
                const lootboxBtn = document.getElementById('lootboxBtn');
                const lootboxContainer = document.getElementById('lootboxContainer');
                const openLootbox = document.getElementById('openLootbox');
                const lootboxResult = document.getElementById('lootboxResult');
                const lootboxCloseBtn = document.getElementById('lootboxCloseBtn');
                
                if (!menuOptions || !lootboxBtn || !lootboxContainer || 
                    !openLootbox || !lootboxResult || !lootboxCloseBtn) {
                    throw new Error("Loot box elements not found");
                }
                
                // Loot box button
                lootboxBtn.addEventListener('click', () => {
                    menuOptions.style.display = 'none';
                    lootboxContainer.style.display = 'flex';
                    lootboxResult.style.display = 'none';
                });
                
                // Open loot box
                openLootbox.addEventListener('click', openLootBox);
                
                // Close loot box
                lootboxCloseBtn.addEventListener('click', () => {
                    lootboxContainer.style.display = 'none';
                });
            } catch (error) {
                console.error("Loot box system initialization error:", error);
            }
        }
        
        function openLootBox() {
            try {
                const openLootbox = document.getElementById('openLootbox');
                const lootboxResult = document.getElementById('lootboxResult');
                const resultTitle = document.getElementById('lootboxResultTitle');
                const resultText = document.getElementById('lootboxResultText');
                
                if (!openLootbox || !lootboxResult) return;
                
                // Disable button during opening
                openLootbox.style.pointerEvents = 'none';
                openLootbox.classList.add('shaking');
                
                // Shake animation
                const lootboxContent = openLootbox.querySelector('.lootbox-content');
                lootboxContent.style.transform = 'scale(1.2)';
                
                // Determine reward after animation
                setTimeout(() => {
                    // Random reward
                    const possibleRewards = [
                        { type: 'skin', shape: 'box', skin: 'gold', text: 'Gold Box Skin' },
                        { type: 'skin', shape: 'circle', skin: 'gold', text: 'Gold Circle Skin' },
                        { type: 'skin', shape: 'triangle', skin: 'gold', text: 'Gold Triangle Skin' },
                        { type: 'skin', shape: 'hexagon', skin: 'gold', text: 'Gold Hexagon Skin' },
                        { type: 'skin', shape: 'box', skin: 'wooden', text: 'Wooden Box Skin' },
                        { type: 'skin', shape: 'circle', skin: 'silver', text: 'Silver Circle Skin' },
                        { type: 'skin', shape: 'triangle', skin: 'crystal', text: 'Crystal Triangle Skin' },
                        { type: 'skin', shape: 'hexagon', skin: 'neon', text: 'Neon Hexagon Skin' },
                        { type: 'points', amount: 100, text: '100 points' },
                        { type: 'yuan', amount: 10, text: '10 yuan' }
                    ];
                    
                    const reward = possibleRewards[Math.floor(Math.random() * possibleRewards.length)];
                    
                    // Apply reward
                    if (reward.type === 'skin') {
                        currentSkins[reward.shape] = reward.skin;
                    } else if (reward.type === 'points') {
                        points += reward.amount;
                    } else {
                        yuan += reward.amount;
                    }
                    
                    // Show result
                    resultText.textContent = reward.text;
                    lootboxResult.style.display = 'flex';
                    
                    // Play sound and particles
                    audio.play('success');
                    spawnParticles(
                        openLootbox.offsetLeft + openLootbox.offsetWidth / 2,
                        openLootbox.offsetTop + openLootbox.offsetHeight / 2,
                        '#FFD700',
                        20
                    );
                    
                    // Reset loot box
                    setTimeout(() => {
                        openLootbox.classList.remove('shaking');
                        lootboxContent.style.transform = 'scale(1)';
                        openLootbox.style.pointerEvents = 'auto';
                    }, 1000);
                }, 500);
            } catch (error) {
                console.error("Error opening loot box:", error);
                const openLootbox = document.getElementById('openLootbox');
                if (openLootbox) {
                    openLootbox.style.pointerEvents = 'auto';
                    openLootbox.classList.remove('shaking');
                }
            }
        }

        // Initialize Shop System
        function initShopSystem() {
            try {
                const menuOptions = document.getElementById('menuOptions');
                const shopBtn = document.getElementById('shopBtn');
                const shopContainer = document.getElementById('shopContainer');
                const shopCloseBtn = document.getElementById('shopCloseBtn');
                
                if (!menuOptions || !shopBtn || !shopContainer || !shopCloseBtn) {
                    throw new Error("Shop elements not found");
                }
                
                // Shop button
                shopBtn.addEventListener('click', () => {
                    menuOptions.style.display = 'none';
                    shopContainer.style.display = 'flex';
                    updateShopBalance();
                });
                
                // Close shop
                shopCloseBtn.addEventListener('click', () => {
                    shopContainer.style.display = 'none';
                });
                
                // Update shop items
                updateShopItems();
            } catch (error) {
                console.error("Shop system initialization error:", error);
            }
        }
        
        function updateShopItems() {
            try {
                const shopItems = document.getElementById('shopItems');
                if (!shopItems) return;
                
                // Clear existing items
                shopItems.innerHTML = '';
                
                // Add shape unlock items
                const shapesToSell = [
                    { name: 'Star', price: 50, icon: '⭐', shape: 'star' },
                    { name: 'Pentagon', price: 30, icon: '⬟', shape: 'pentagon' },
                    { name: 'Trapezoid', price: 40, icon: '⏢', shape: 'trapezoid' }
                ];
                
                shapesToSell.forEach(item => {
                    const shopItem = document.createElement('div');
                    shopItem.className = 'shop-item';
                    
                    // Check if already unlocked
                    const isUnlocked = unlockedShapes.includes(item.shape);
                    
                    shopItem.innerHTML = `
                        <div class="shop-item-icon">${item.icon}</div>
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price">${item.price} ${translations[selectedLanguage]?.yuan || 'yuan'}</div>
                    `;
                    
                    if (isUnlocked) {
                        shopItem.innerHTML += '<div style="color: #34C759; font-size: 12px;">UNLOCKED</div>';
                        shopItem.style.opacity = '0.7';
                    } else {
                        shopItem.addEventListener('click', () => {
                            if (yuan >= item.price) {
                                yuan -= item.price;
                                unlockedShapes.push(item.shape);
                                updateShopItems();
                                updateShopBalance();
                                showNotification(`Unlocked ${item.name}!`);
                                
                                // Play sound and particles
                                audio.play('success');
                                spawnParticles(
                                    shopItem.offsetLeft + shopItem.offsetWidth / 2,
                                    shopItem.offsetTop + shopItem.offsetHeight / 2,
                                    '#FFD700',
                                    10
                                );
                            } else {
                                showNotification("Not enough yuan!", true);
                            }
                        });
                    }
                    
                    shopItems.appendChild(shopItem);
                });
            } catch (error) {
                console.error("Error updating shop items:", error);
            }
        }
        
        function updateShopBalance() {
            try {
                const shopBalance = document.getElementById('shopBalance');
                if (shopBalance) {
                    shopBalance.textContent = `${yuan} ${translations[selectedLanguage]?.yuan || 'yuan'}`;
                }
            } catch (error) {
                console.error("Error updating shop balance:", error);
            }
        }

        // Initialize pause system
        function initPauseSystem() {
            try {
                const pauseOverlay = document.getElementById('pauseOverlay');
                const resumeBtn = document.getElementById('resumeBtn');
                
                if (!pauseOverlay || !resumeBtn) return;

                resumeBtn.addEventListener('click', () => {
                    togglePause(false);
                });
            } catch (error) {
                console.error("Pause system initialization error:", error);
            }
        }

        function togglePause(forceState = null) {
            try {
                const pauseOverlay = document.getElementById('pauseOverlay');
                const t = translations[selectedLanguage] || translations.en;
                
                // Determine new state
                const newState = forceState !== null ? forceState : !isPaused;
                
                if (newState) {
                    // Pause the simulation
                    prePauseRunner = runner;
                    Runner.stop(runner);
                    runner = null;
                    isPaused = true;
                    
                    // Show pause overlay
                    pauseOverlay.style.display = 'flex';
                    
                    // Allow editing while paused
                    document.getElementById('editControls').style.display = 'flex';
                } else {
                    // Resume the simulation
                    if (prePauseRunner) {
                        runner = Runner.create({
                            delta: 1000 / 60,
                            isFixed: true
                        });
                        Runner.run(runner, engine);
                        prePauseRunner = null;
                    }
                    isPaused = false;
                    
                    // Hide pause overlay
                    pauseOverlay.style.display = 'none';
                    
                    // Hide edit controls if not in edit mode
                    if (!editMode) {
                        document.getElementById('editControls').style.display = 'none';
                    }
                }
            } catch (error) {
                console.error("Error toggling pause:", error);
            }
        }

        // Initialize Touch Controls
        function initTouchControls() {
            try {
                const canvas = document.getElementById('canvas');
                if (!canvas) return;
                
                let touchStartPos = null;
                let touchStartTime = 0;
                let initialDistance = 0;
                let initialSize = 0;
                let longPressTimer = null;
                const LONG_PRESS_DURATION = 500; // ms

                // Single touch handlers
                canvas.addEventListener('touchstart', (e) => {
                    if (e.touches.length === 1) {
                        const touch = e.touches[0];
                        touchStartPos = { x: touch.clientX, y: touch.clientY };
                        touchStartTime = Date.now();
                        
                        // Long press for edit mode
                        longPressTimer = setTimeout(() => {
                            if (!touchStartPos) return;
                            const rect = canvas.getBoundingClientRect();
                            const x = touch.clientX - rect.left;
                            const y = touch.clientY - rect.top;
                            const found = Query.point(bodies, {x, y});
                            if (found.length) enterEditMode(found[0]);
                        }, LONG_PRESS_DURATION);
                    }
                    e.preventDefault();
                }, { passive: false });

                canvas.addEventListener('touchend', (e) => {
                    clearTimeout(longPressTimer);
                    
                    if (!touchStartPos || e.changedTouches.length !== 1) return;
                    const touch = e.changedTouches[0];
                    const endPos = { x: touch.clientX, y: touch.clientY };
                    const duration = Date.now() - touchStartTime;
                    
                    // Handle tap
                    if (duration < 300 && 
                        Math.hypot(endPos.x - touchStartPos.x, endPos.y - touchStartPos.y) < 10) {
                        handleTap(touch);
                    }
                    
                    touchStartPos = null;
                    initialDistance = 0;
                    e.preventDefault();
                }, { passive: false });

                // Pinch zoom for resizing in edit mode
                canvas.addEventListener('touchmove', (e) => {
                    if (editMode && selectedBody && e.touches.length === 2) {
                        const touch1 = e.touches[0];
                        const touch2 = e.touches[1];
                        const currentDistance = Math.hypot(
                            touch2.clientX - touch1.clientX,
                            touch2.clientY - touch1.clientY
                        );
                        
                        if (initialDistance === 0) {
                            initialDistance = currentDistance;
                            initialSize = selectedBody.bounds.max.x - selectedBody.bounds.min.x;
                        } else {
                            const scale = currentDistance / initialDistance;
                            resizeBody(selectedBody, initialSize * scale);
                            document.getElementById('sizeSlider').value = initialSize * scale;
                        }
                        
                        e.preventDefault();
                    }
                }, { passive: false });

                function handleTap(touch) {
                    const rect = canvas.getBoundingClientRect();
                    const x = touch.clientX - rect.left;
                    const y = touch.clientY - rect.top;
                    
                    if (currentMode === 'delete') {
                        const found = Query.point(bodies, {x, y});
                        if (found.length) removeBody(found[0]);
                    } else {
                        // Create only one object at the touch position
                        const body = createBody(x, y);
                        if (body) {
                            audio.play('click');
                            spawnParticles(x, y, body.render.fillStyle, 3);
                        }
                    }
                }
            } catch (error) {
                console.error("Touch controls initialization error:", error);
            }
        }

        // Window Resize Handler
        window.addEventListener('resize', () => {
            try {
                if (!render) return;

                const canvas = document.getElementById('canvas');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight - 44;

                render.options.width = canvas.width;
                render.options.height = canvas.height;
                render.bounds.max.x = canvas.width;
                render.bounds.max.y = canvas.height;

                const walls = Composite.allBodies(engine.world)
                    .filter(b => b.isStatic);

                if (walls.length >= 3) {
                    Body.setPosition(walls[0], {
                        x: canvas.width/2,
                        y: canvas.height + 20
                    });

                    Body.setPosition(walls[1], {
                        x: -30,
                        y: canvas.height/2
                    });

                    Body.setPosition(walls[2], {
                        x: canvas.width + 30,
                        y: canvas.height/2
                    });
                }
                
                // Adjust dock position based on orientation
                const dock = document.getElementById('dock');
                if (dock) {
                    if (window.innerWidth > window.innerHeight) {
                        // Landscape mode
                        dock.style.bottom = '10px';
                    } else {
                        // Portrait mode
                        dock.style.bottom = '20px';
                    }
                }
            } catch (error) {
                console.error("Error handling window resize:", error);
            }
        });
    </script>
</body>
</html>
